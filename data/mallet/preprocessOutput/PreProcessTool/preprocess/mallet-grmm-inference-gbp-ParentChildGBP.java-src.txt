2003 m a l l e t m achine languag e ~mccallum 1 0 further ` l i e n s e inference gbp logging logger logging level inference inferencer types logger timing created may 27 2005 author < a h r e f= mailto casutton edu>casutton edu< a> $ parent child g b p v 1 1 2007 10 22 21 37 58 exp $ parent child g b p inferencer logger logger = logger get logger parent child g b p get name debug = region graph generator regioner message strategy sender use inertia = inertia weight = 0 5 convergence criteria t h r e s h o l d = 1e 3 m a x i t e r = 500 current inferencing state message old messages message messages region graph rg factor graph mdl parent child g b p parent child g b p region graph generator regioner regioner full message strategy parent child g b p region graph generator regioner message strategy sender regioner = regioner sender = sender parent child g b p make b p inferencer parent child g b p inferencer = parent child g b p inferencer regioner = b p region generator inferencer sender = full message strategy inferencer parent child g b p make kikuchi inferencer parent child g b p inferencer = parent child g b p inferencer regioner = kikuchi4 square region generator inferencer sender = full message strategy inferencer accessors get use inertia use inertia set use inertia use inertia use inertia = use inertia get inertia weight inertia weight set inertia weight inertia weight inertia weight = inertia weight inferencer factor lookup marginal variable variable region region = rg find containing region variable region == illegal argument could not find region containing variable +variable+ in region graph +rg factor belief = compute belief region factor var belief = belief marginalize variable var belief factor lookup marginal var set var set region region = rg find containing region var set region == illegal argument could not find region containing clique +var set + in region graph +rg factor belief = compute belief region factor clique belief = belief marginalize var set clique belief factor compute belief region region compute belief region messages factor compute belief region region message messages discrete factor result = log table factor region vars iterator it = region factors iterator it has next factor factor = factor it next result multiply factor iterator it = region parents iterator it has next region parent = region it next factor msg = messages get message parent region result multiply msg iterator it = region descendants iterator it has next region child = region it next iterator it2 = child parents iterator it2 has next region uncle = region it2 next uncle != region !region descendants contains uncle result multiply messages get message uncle child result normalize result lookup log joint assignment assn factor product = mdl log value assn value += compute free energy rg f = compute free energy rg value = factor product + f debug err g b p factor product +factor product+ + free energy + f+ = value +value value compute free energy region graph rg avg energy = 0 entropy = 0 iterator it = rg iterator it has next region region = region it next factor belief = compute belief region entropy = belief entropy debug err region + region + + region counting number + entropy + entropy entropy += region counting number entropy discrete factor product = log table factor belief var set iterator ptl it = region factors iterator ptl it has next factor ptl = factor ptl it next product multiply ptl avg energy = 0 assignment iterator assn it = belief assignment iterator assn it has next assignment assn = assn it assignment note not use assn it here before fixing variable ordering issues energy = product log value assn energy = product phi assn it bel = belief value assn avg energy += bel energy assn it advance debug err region + region + + region counting number + avg energy + avg energy discrete potential b2 = belief duplicate b2 delogify err b e l i e f +b2 err e n e r g y +product avg energy += region counting number avg energy debug err g b p compute free energy avg energy +avg energy+ entropy +entropy+ free energy + avg energy entropy avg energy + entropy avg energy entropy compute marginals factor graph mdl timing timing = timing mdl = mdl rg = regioner construct region graph mdl region edge pairs = choose message sending order messages = message rg timing tick g b p region graph construction iter = 0 old messages = messages messages = old messages duplicate sender set message old messages messages i = 0 i < pairs length i++ region edge edge = pairs i sender send message edge logger loggable level f i n e r timing tick g b p iteration +iter iter++ use inertia messages = sender average messages rg old messages messages inertia weight !has converged iter < m a x i t e r logger info g b p used +iter+ iterations iter >= m a x i t e r logger warning w a r n i n g g b p not converged! region edge choose message sending order list l = list iterator it = rg edge iterator it has next region edge edge = region edge it next l add edge collections sort l comparator compare o1 o2 region edge e1 = region edge o1 region edge e2 = region edge o2 l1 = e1 to vars size l2 = e2 to vars size compare l1 l2 region edge l to region edge l size has converged iterator it = rg edge iterator it has next region edge edge = region edge it next factor old msg = old messages get message edge from edge to factor msg = messages get message edge from edge to old msg == msg == !old msg almost equals msg t h r e s h o l d xxx debug sender sparse message sender out n o t o n v e r g e d +new msg+ dump iterator it = rg edge iterator it has next region edge edge = region edge it next factor msg = messages get message edge from edge to out message +edge from+ > +edge to+ +new msg 
topics types word embedding runnable runnable word embeddings model instance list instances num samples should run = residual = 0 0 num updates = 0 num threads thread stride doc random random num columns words so far = 0 word embedding runnable word embeddings model instance list instances num samples num threads thread model = model stride = model stride instances = instances num samples = num samples num threads = num threads thread = thread random = random num columns = model num columns get mean num updates == 0 doc result = residual num updates residual = 0 0 num updates = 0 result run num documents = instances size sample normalizer = 1 0f num samples gradient = num columns query = model vocabulary lookup index model query word output offset = model num columns doc = thread num documents num threads max doc = thread + 1 num documents num threads max doc > num documents max doc = num documents cache scale = 1 0 model max exp value model min exp value token buffer = 100000 should run instance instance = instances get doc doc id++ doc == max doc start over at beginning doc = thread num documents num threads rate = math max 0 0001 0 025 1 0 num threads words so far model total words feature sequence tokens = feature sequence instance get data original length = tokens get length length = 0 input position = 0 input position < original length input position++ input type = tokens get index at position input position words so far++ frequency score = model word counts input type 0 0001 model total words random next < math sqrt frequency score + 1 frequency score token buffer length = input type length++ skip documents length < 10 input position = 0 input position < length input position++ input type = token buffer input position sub window = model window size start = math max 0 input position sub window end = math min length 1 input position + sub window output position = start output position <= end output position++ input position == output position output type = token buffer output position input type == output type inner product = model weights input type stride + 0 + model weights input type stride + output offset col = 1 col < num columns col++ inner product += model weights input type stride + col model weights output type stride + output offset + col prediction inner product < model min exp value prediction = 0 0 inner product > model max exp value prediction = 1 0 prediction = model sigmoid cache math floor model sigmoid cache size inner product model min exp value cache scale ! na n prediction gradient 0 = 1 0f prediction model weights output type stride + output offset += rate 1 0f prediction col = 1 col < num columns col++ gradient col = 1 0f prediction model weights output type stride + output offset + col model weights output type stride + output offset + col += rate 1 0f prediction model weights input type stride + col output type == query out format neg %f g %f model negative weights input type 0 rate 1 0 prediction mean negative prediction = 0 0 sample = 0 sample < num samples sample++ sampled type = model sampling table random next model sampling table size out format %s %s %d vocabulary lookup output type vocabulary lookup sampled type 0 sampled type offset = sampled type stride inner product = model weights input type stride + 0 + model weights sampled type offset + output offset col = 0 col < num columns col++ inner product += model weights input type stride + col model weights sampled type offset + output offset + col negative prediction = 0 0 inner product < model min exp value negative prediction = 0 0 inner product > model max exp value negative prediction = 1 0 negative prediction = model sigmoid cache math floor model sigmoid cache size inner product model min exp value cache scale ! na n negative prediction mean negative prediction += negative prediction gradient 0 += sample normalizer negative prediction model weights sampled type offset + output offset += rate sample normalizer negative prediction col = 1 col < num columns col++ gradient col += sample normalizer negative prediction model weights sampled type stride + output offset + col model weights sampled type offset + output offset + col += rate sample normalizer negative prediction model weights input type stride + col residual += prediction mean negative prediction sample normalizer num updates++ col = 0 col < num columns col++ model weights input type stride + col += rate gradient col 